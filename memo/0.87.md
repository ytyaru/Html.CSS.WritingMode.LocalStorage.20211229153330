# 0.87 パフォーマンス考察

1. 最初は`content-visibility:hidden`にする
2. 初期処理が完了したら`content-visibility:auto`にする

　これで5秒くらいにまでなった。けれどページ計算処理などが破綻している。ページ計算は全コンテンツがなければ計算できないため。

## 案

A. 中間形式テキストを分割で取得し、1画面分表示できるならHTML化して表示する。次ページ遷移するごとにこれを繰り返す
B. ページ分割処理だけWASMで実装する
C. CSS変数をできるだけJSに移行する

### A. 中間形式テキストを分割で取得し、1画面分表示できるならHTML化して表示する。次ページ遷移するごとにこれを繰り返す

　大改修になってしまう。また、中間形式からHTMLへパースする処理も必要なため非同期処理が必須になるだろう。あるいはWASMによる根本的なパフォーマンス改善が必要。

　WASMもまだまだで逆に遅くなることすらありうる。はたしてやる価値があるのか。

### B. ページ分割処理だけWASMで実装する

　上記と同じくやる価値があるのか疑問。

### C. CSS変数をできるだけJSに移行する

　ボトルネックはCSSだと思われる。ページ遷移で使っている`--page-index`もCSS変数であり、`content-visibility:hidden`で壊れたのはCSS変数を使っているからではないか。その証拠に、JSで実装した読了率（`read-rate`）だけはちゃんと動作した。

　そもそも`content-visibility`もCSS負荷をさげるためのもの。そんなことをしなきゃいけない時点でクソだし、それをしたせいでシステムが破壊されてしまうなら、CSS変数を使った処理は怖くてできない。`--page-index`などページ遷移系処理はJSに移行すべき。

　JSのObjectでクラス風に実装するのが良いと思う。

* https://www.yunabe.jp/docs/javascript_class_in_google.html

