# 0.63 不要なファイル、関数、コメントアウトを削除した。

## 考察

1. ビューアのWebComponent化
2. ページ数表示パターン（通し番号。ノンブル。残り。割合％）
3. wring-modeに応じて変化するCSS論理プロパティまとめ（位置・サイズ）
4. `<br>`の使い方
5. 文字列検索したときスクロール位置がページをまたいでしまう
6. 前回終了時の復元
7. 背景黒
8. フォント

### 1. ビューアのWebComponent化

```html
<book-viewer></book-viewer>
<book-viewer header="heading" footer="number"></book-viewer>
```

### 2. ページ数表示パターン（通し番号。ノンブル。残り。割合％）

```
　　　　　　　　　　　↑抽象
　　　　+---------------------------------+
　　　　|                         柱      |
　　　　|   +------------------------+    |
　　　　|   |                        |    |
　　　　|   |                        |    |
←前後　|   |         本文           |    |前後→
　　　　|   |                        |    |
　　　　|   |                        |    |
　　　　|   |                        |    |
　　　　|   +------------------------+    |
　　　　|                        ノンブル |
　　　　+---------------------------------+
　　　　　　　　　　　↓具象
```

writing-mode|←|→
------------|--|--
`horizontal-tb`|戻る|進む
`vertical-rl`|進む|戻る

位置|役割|概要
----|----|----
↑|抽象|この文書の上位概念。すなわちインデックス（柱（現在閲覧中の章）、この冊子のタイトル、巻数、著者、シリーズ）。またはシステム。
↓|具象|この文書の下位概念。すなわち表示設定、ノンブル。


```
vertical-rl
　　　　　　　　　　　↑抽象
　　　　+---------------------------------+
　　　　|                         柱      |
　　　　|   +------------------------+    |
　　　　|   |                        |    |
　　　　|   |                        |    |
←未来　|   |         本文           |    |過去→
　　　　|   |                        |    |
　　　　|   |                        |    |
　　　　|   |                        |    |
　　　　|   +------------------------+    |
　　　　|                        ノンブル |
　　　　+---------------------------------+
　　　　　　　　　　　↓具象
```

```
horizontal-tb
　　　　　　　　　　　↑抽象
　　　　+---------------------------------+
　　　　|                         柱      |
　　　　|   +------------------------+    |
　　　　|   |                        |    |
　　　　|   |                        |    |
←過去　|   |         本文           |    |未来→
　　　　|   |                        |    |
　　　　|   |                        |    |
　　　　|   |                        |    |
　　　　|   +------------------------+    |
　　　　|                        ノンブル |
　　　　+---------------------------------+
　　　　　　　　　　　↓具象
```


```
vertical-rl
　　　　　　　　　　　↑抽象
　　　　+---------------------------------+
　　　　|現在時刻     経過時間          柱|
　　　　|   +------------------------+    |
　　　　|   |                        |    |
　　　　|   |                        |    |
←未来　|   |         本文           |    |過去→
　　　　|   |                        |    |
　　　　|   |                        |    |
　　　　|   |                        |    |
　　　　|   +------------------------+    |
　　　　|あと         ノンブル      読了率|
　　　　+---------------------------------+
　　　　　　　　　　　↓具象
```
```
horizontal-tb
　　　　　　　　　　　↑抽象
　　　　+---------------------------------+
　　　　|柱         経過時間      現在時刻|
　　　　|   +------------------------+    |
　　　　|   |                        |    |
　　　　|   |                        |    |
←過去　|   |         本文           |    |未来→
　　　　|   |                        |    |
　　　　|   |                        |    |
　　　　|   |                        |    |
　　　　|   +------------------------+    |
　　　　|読了率         ノンブル      あと|
　　　　+---------------------------------+
　　　　　　　　　　　↓具象
```

--|未来|現在|過去
--|----|----|----
↑|現在時刻|経過時間|柱
↓|あと|ノンブル|読了率

項目|概要|例
----|----|--
現在時刻|全画面のとき現在時刻を表示する|`12:34`,`00:00`
経過時間|最後に起動してからの経過時間を表示する|`1m`,`1h 23m`,`1時間23分`
柱|現在閲覧中の章数、章名を表示する|`第1章 見出し`
あと|残りページ数を表示する|`あと231`
ノンブル|現在ページ数を表示する|`1`
読了率|文書全体のうち読み終わった割合を表示する|`32%`

　表示位置は上記パターンで固定する。理由は次の通り。

* 本に模して実装する
* 本は左綴じ、右綴じである
* ページめくりは左か右である（上下はない）
* 本ではノンブルが下に表示されていることが多い
* 本では柱が上に表示されていることが多い
* 目の動線は上から下である
* 物事の概念の抽象・具象は上下関係である
* 物理的な位置と概念的な位置を一致させることで直感的にわかりやすくする
* 現在時刻は読者の未来の予定を立てるために表示する（表示位置が中央でなく端なのは読者の目的が未来軸のため）
* 経過時間は読者が現在どれくらい読書に時間をかけたか知るために表示する（表示位置が中央なのは読者の目的が現在軸だから。なお経過時間はウインドウがアクティブのときのみ加算するようにするなど工夫したほうがいい）
* 柱は読者が全体からみた現在位置を上から俯瞰できるようにするために表示する（表示位置が中央でなく端なのは長いテキストでも表示できるようにするため）
* 残りページ数は、あといくつめくればいいか未来を概算できるようにするために表示する（所要時間を見積もり予定を立てる）
* 現在ページ数は、現在位置を知る指標として表示する（現在位置の把握。前回終了時点の復元）
* 読了率は、過去これまで全体のうちどれくらい読み終わったか達成率を知るために表示する（達成感を得る）

　各項目の表示／非表示はビューア設定で切り替えられる。

```
☑ 余白
----------------------------------------
       [1]em
[1]em         [1]em
       [1]em

☑ 表示
----------------------------------------
☑ 現在時刻                   ☑ 柱
                 ☑ つめかけ
☑ 残りページ数  ☑ ノンブル  ☑ 読了率
```

　余白と補足の表示ON/OFFは次のような関係である。

余白|補足
----|----
⭕|⭕
⭕|❌
❌|❌

　余白があれば補足が表示できる。補足は余白領域に表示するから。よって余白がないのに補足を表示しようとすることはできない。もし表示すれば本文と重なってしまい、本文が読めなくなってしまうから。

　余白は`0`〜`9`までの整数値。字／行が40〜50であることから余白の適正値も算出できそう。大体12,3mm。上は15mmなど少し多めのことが多い。10〜18mmの間。1字あたり5mm程度。よって2.5〜3emくらいが妥当。多くても2〜4emの範囲内。ノドが多めになるが綴じるため余計に多く必要になる。本特有の物理的な事情である。ディスプレイの場合ノドは考慮しなくていい。

* https://togetter.com/li/725256

　上部の余白が`0`ならば現在時刻と柱はグレーアウトし、自動的に非表示となる。表示領域がないから。おなじく下部の余白が`0`ならば残りページ数、ノンブル、読了率は自動的に非表示となる。

　つめかけも同じ。つめかけは左右に表示されるため、左右の余白が`0`なら非表示になる。ふつう左右の余白は同じ値になるはず。そしてつめかけは進行方向によって前までの全章と、次からの全章をそれぞれ左右に表示する。両方そろって全体の章が把握でき、そこへのインデックスとなる。

　本におけるページは以下のような構造になっている。

重要度|位置|役割
------|----|----
1|中央|文書の内容である本文を表示する
2|下|ノンブルをはじめ現在位置を知る
3|上|柱をはじめ上位概念の情報を知る
4|左右|つめかけ。章の把握とインデックス

　中央の本文だけは必須。ノンブルもほぼ必須だが、本文だけに集中したいときやページ数が少ないときなどはその領域を本文にあてることもできる。以降、柱やつめかけの優先度は低い。上端をクリックしたらそれらにアクセスできるようにする予定だから。それでも表示するのは、わざわざ上端クリックしてメニュー選択せずとも常時閲覧できるようにしたほうが便利なときもあるから。

### 3. wring-modeに応じて変化するCSS論理プロパティまとめ（位置・サイズ）

* https://coliss.com/articles/build-websites/operation/css/new-css-logical-properties.html

相対|horizontal-tb|vertical-rl
----|-------------|-----------
`block-size`|`height`|`width`
`inline-size`|`width`|`height`

相対|horizontal-tb|vertical-rl
----|-------------|-----------
`block-start`系|`top`系|`right`系
`block-end`系|`bottom`系|`left`系
`inline-start`系|`left`系|`top`系
`inline-end`系|`right`系|`bottom`系

　`padding`,`border`,`margin`のサイズに関してもこれに従う。

相対|horizontal-tb|vertical-rl
----|-------------|-----------
`padding-block-start`|`padding-top`|`padding-right`
`padding-block-end`|`padding-bottom`|`padding-left`
`padding-inline-start`|`padding-left`|`padding-top`
`padding-inline-end`|`padding-right`|`padding-bottom`

相対|horizontal-tb|vertical-rl
----|-------------|-----------
`border-block-start`|`border-top`|`border-right`
`border-block-end`|`border-bottom`|`border-left`
`border-inline-start`|`border-left`|`border-top`
`border-inline-end`|`border-right`|`border-bottom`

相対|horizontal-tb|vertical-rl
----|-------------|-----------
`margin-block-start`|`margin-top`|`margin-right`
`margin-block-end`|`margin-bottom`|`margin-left`
`margin-inline-start`|`margin-left`|`margin-top`
`margin-inline-end`|`margin-right`|`margin-bottom`

　位置に関しては以下の通り。

相対|horizontal-tb|vertical-rl
----|-------------|-----------
`inset-block-start`|`top`|`right`
`inset-block-end`|`bottom`|`left`
`inset-inline-start`|`left`|`top`
`inset-inline-end`|`right`|`bottom`

　けれどページめくり方向（左綴じ／右綴じ）などに関しては指定できない。

```css
--page-start: left/right;
--page-end: right/left;

--page-left;
--page-right:
--page-top:
--page-bottom:

--page-direction: left, right (horizontal-tb, vertical-rl)
--inset-page-start
--padding-page-start
--border-page-end
--margin-page-end

```

* ページめくり方向（左綴じ／右綴じ）
* ページ開始位置
* ページ終了位置
* 

### 4. `<br>`の使い方

```markdown
# 要素

要素|意味|MDN
----|----|---|
`<p>`|段落|[<p>][p]
`<br>`|改行|[<br>][br]

## `<p>`

```html
<p>要約文です。詳細文が続きます。こんなふうにね。</p>
```

　`<p>`はパラグラフ（段落）を表す。HTMLにおいて文章は[<p>][p]要素のテキストコンテントに書く。パラグラフ・ライティングによれば段落は要約文と詳細文に大別される。最初の文さえ読めば概要が把握できるように書く。複数の段落で構成された文章のとき、要約文だけを読めば概要が把握できるようになる。速読はそうして行われる。

## `<br>`

```html
<p>要約文です。<br>詳細文が続きます。<br>こんなふうにね。</p>
```

　`<br>`は改行を表す。HTMLにおいて改行コードは`<pre>`のテキストコンテント以外では無視される。もし特定の箇所で改行させたくば`<br>`を使うことになる。さもなくば普通は画面の端で自動的に折り返しされることになる。

# `<br>`の使い方について

* 複数回改行した分だけのスペースが欲しい
* 長すぎるから改行したい
* 短すぎるから改行したくない

## 複数回改行した分だけのスペースが欲しい

　`<br>`を連続で複数回使うのはNG。読み上げソフトの妨げになりアクセシビリティが下がるから。よって以下のようなコードはダメ。

```html
<p>一行目です。<br>二行目です。<br><br><br>三行目です。</p>
```

　でも複数行分の改行スペースは開けたい。そんなときはCSSを使う。`margin`よりも`line-height`を使うべき。つまり以下のようなコードが望ましい。

```html
<p>一行目です。<br>二行目です。<br height="3">三行目です。</p>
```
```css
br {
    line-height: calc(var(attr(height), 1) * 1em);
}
```

　ところが、以下コードを書いても１行分のスペースしか開かなかった。

```html
<style>br { line-height:2em; }</style>
<p>一行目です。<br>二行目です。<br height="3">三行目です。</p>
```
```html
<style>br { margin:2em; }</style>
<p>一行目です。<br>二行目です。<br height="3">三行目です。</p>
```
```html
<style>br { line-height: calc(var(attr(height), 1) * 1em); }</style>
<p>一行目です。<br>二行目です。<br height="3">三行目です。</p>
```
```html
<style>br { margin: calc(var(attr(height), 1) * 1em); }</style>
<p>一行目です。<br>二行目です。<br height="3">三行目です。</p>
```

　どうやら`<br>`要素にCSSを付与しても適用されないらしい。MDNではできると書いていたのに。仕方ないから`<p>`に`margin`を設定することで代用する。

```html
<style>p { margin-block-end: calc(var(--not-define, attr(height), 1) * 1em); }</style>
<p>一段落目です。その詳細文が続きます。</p>
<p>二段落目です。各段落の末尾には余白がつきます。</p>
<p height="3">三段落目です。余白サイズを変更するには<code>height</code>属性値にem単位の数値をセットしてください。ここでは3emの余白、つまり3行分の余白がつきます。</p>
<p>四段落目です。各段落の末尾には余白がつきます。画面下端でさえ付与されてしまいます。</p>
```

　動かない。どうやら`attr()`は`content`プロパティに値をセット刷るときにしか使えないらしい。

* https://stackoverflow.com/questions/46323117/using-html-data-attributes-as-css-variable-i-e-text-shadow

```html
<style>p.multi-line { margin-block-end: calc(var(--height, attr(integer height), 1) * 1em); }</style>
<p>一段落目です。その詳細文が続きます。</p>
<p>二段落目です。各段落の末尾には余白がつきます。</p>
<p class="multi-line" style="--height:3;">三段落目です。余白サイズを変更するには<code>height</code>属性値にem単位の数値をセットしてください。ここでは3emの余白、つまり3行分の余白がつきます。</p>
<p>四段落目です。各段落の末尾には余白がつきます。画面下端でさえ付与されてしまいます。</p>
```

　これでやっとできた。けれど冗長すぎる。こんなクソコードを手書きしていたら人生が終わる。ここまでやるなら以下のように直接書いたほうが早い。

```html
<p>一段落目です。その詳細文が続きます。</p>
<p>二段落目です。各段落の末尾には余白がつきます。</p>
<p style="margin-block-end:3em;">三段落目です。余白サイズを変更するには<code>height</code>属性値にem単位の数値をセットしてください。ここでは3emの余白、つまり3行分の余白がつきます。</p>
<p>四段落目です。各段落の末尾には余白がつきます。画面下端でさえ付与されてしまいます。</p>
```

　やはりHTML自体が冗長と言わざるを得ない。

　そもそも複数行の改行を許したら読みづらくなる。WEB小説ではわざとスペースを増やすこともある。字がつまりすぎている印象を薄めるために。けれどそんな姑息な見た目の小細工よりも、話題や焦点をはっきりさせて意味が理解しやすい文章を書くほうが大事。でも選択肢としては欲しい。

## 長すぎるから改行したい

　ふつう文章は長すぎると読みにくい。日本語は１行あたり40〜50字くらいが読みやすいとされている。そのため適当なところで改行するなり、本文全体の幅を小さくして自動折り返しさせるなどで誤魔化していた。

　新聞や論文では段組みして１行あたりの字数を調整していた。CSSでは段組み機能がなかったり、ブラウザ対応率が低いなどの問題がある。そのせいでいまだに改行が利用される。

　だが、改行は悪である。スマホなど解像度が大きく異なる環境では妙なところで改行が入ってしまい読みづらくなることがあるから。

　昨今、高解像度ディスプレイが普及してきた。16:9で1920x1080。かつて普及していた1024x768と比べると倍近い横幅だ。もしフォントサイズにしろ改行にしろ、それぞれのデバイスで１行あたり40〜50字にしたいが、そのように設定できるプロパティは存在しない。よって改行でごまかす手法を使う。だが、改行があるせいで解像度が大きく異なるデバイスでは読みづらくなってしまう。ジレンマである。

　正しい対処としては次の通りだ。

* １行あたり40〜50字になるようフォントサイズを画面サイズに応じて動的に計算してセットする
* `<br>`による改行は一切しない
* `<p>`にCSSで余白を設定する：`p {margin-block-end:1em;}`
* もしフォントサイズが大きすぎたら段組みして１画面あたりの表示字数を増やせるようにする

## 短すぎるから改行したくない

　長すぎるから改行したいの逆バージョン。

　サイズをスマホに合わせて改行していると、大型ディスプレイで見たときムダに改行が多すぎて読みづらくなる。

　つまるところ、レスポンシブ対応として先述のとおりにすべきである。

## 末尾の`<p>`には余白をつけたくない

　改行を使うのは悪手。よってCSSで`<p>`の余白をセットすることで段落間に余白があるように見せるよう実装すべきだとわかった。コードでいうと以下。

style.css
```css
p { margin-block-end:1em; }
```
index.html
```html
<p>要約文１。詳細文１。</p>
<p>要約文２。上の段落との間に余白があるはず。</p>
```

　ところが、上記の方法では問題がある。段組みやページの区切りにおいてその末尾にある`<p>`要素には余白をつけたくない場合がある。

style.css
```css
* {
    padding:0;
    margin:0;
}
body {
    column-count: 2;
}
p:not(:first-child) {
    break-before:column;
}
p {
    margin-block-end:1em;
}
```
index.html
```html
<p>要約文１。詳細文１。</p>
<p>要約文２。上の段落との間に余白があるはず。</p>
```

　すると各段落の末尾行に余白ができてしまう。

```
段組み１。｜段組み２。

```

```css
p:not(:last-child-of-column) {
    margin-block-end:1em;
}
```

* [疑似クラスと疑似要素](https://developer.mozilla.org/ja/docs/Learn/CSS/Building_blocks/Selectors/Pseudo-classes_and_pseudo-elements)

<a id="impressions"></a>
# [所感](#impressions)

　

[p]:https://developer.mozilla.org/ja/docs/Web/HTML/Element/p
[br]:https://developer.mozilla.org/ja/docs/Web/HTML/Element/br

<a id="target-environment"></a>
# [対象環境](#target-environment)

* <time datetime="2022-01-16T16:07:50+0900" title="実施日">2022-01-16</time>
```

### 5. 文字列検索したときスクロール位置がページをまたいでしまう

　現状、ブラウザの文字列検索をすると段組み（ページ）をまたいでスクロールしてしまう。なんとかしたい。案は以下。

* スクロールイベント([scroll event][])をフックして直近の`page`属性値をもつ`p`要素に`scrollIntoView`する

```javascript
window.addEventListener('scroll', function(e) {
    window.scrollY;
});
```

[scroll event]:https://developer.mozilla.org/ja/docs/Web/API/Document/scroll_event

### 6. 前回終了時の復元

　前回終了時の復元をしたい。同じページ位置に復帰したい。ページ数は画面サイズやフォントサイズに依存している。それでもIndexedDBでHTML要素型のまま保存できれば、そこへ`scrollIntoView`すれば復帰できるかもしれない。要調査。

### 7. 背景黒

　背景色と文字色を変えたい。

* 背景を白／黒にしたい
* 日没時刻から自動的に変更するようにしたい
* 背景色をLCH形式で自由に入力したい
* 文字色を背景色と比較してコントラスト比4.5以上の値にしたい（白／黒のいずれか）

### 8. フォント

　指定したフォントに変更したい。TrueTypeよりOpenTypeがいい。`font-feature-settings`できるから。

* IPAex明朝、IPAexゴシック

言語/用途|本文|見出し
---------|----|------
日本語|明朝|ゴシック
英語|serif|suns-serif

　`Noto Serif JP`, `Noto Sans JP`。6MBくらいあった。「源ノ角ゴシック」と「Noto Sans CJK JP」は同じ。

* https://fonts.google.com/noto/fonts?noto.query=jp
* https://fonts.google.com/noto/specimen/Noto+Sans+JP?noto.query=jp
* https://fonts.google.com/noto/specimen/Noto+Serif+JP?noto.query=jp

　他は以下で探す。

* https://leafscape.be/
* https://okoneya.jp/font/genei-chikumin.html

　欲しいパターンは以下。

* 手書き風
* 血文字
* 毛筆
* ドット

