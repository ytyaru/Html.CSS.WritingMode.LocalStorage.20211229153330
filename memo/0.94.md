# 0.94 light/darkのシステム側との連携について

　本ツールにはlight/darkモードがある。これはボタンにより変更することができる。問題は、それ以外にもモード変更する場合があることだ。

　CSSのメディアクエリを使えばOS側のlight/dark設定と連動してWEBページもそれに合わせることができる。

```css
// OSのダークモード変更に合わせる
window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
    setColorScheme((event.matches) ? 'dark' : 'light')
});
```

　普通はOSのそれと連動させればいいと思う。ただ、前回終了時の復元とどちらを優先すべきか。ボタン操作による変更が最優先される。

## カラースキーム変更表

タイミング|処理
----------|----
初回ロード時|前回終了時の設定／現在OS設定値／独自アルゴリズム
OS設定値変更|OSに合わせる／合わせない
ボタン押下|必ず変更する

　OSのカラースキームと合わせるべきか否か。その答えを導くには、そもそも何のためにカラースキームを変更するかを考えるべき。

　カラースキーム、特にlight/darkモードを変更する理由は「目の保護」である。ふつう白背景がもっとも馴染み深い。また、環境光が強い日中においては白背景のほうが見やすい。ただ、夜になり環境光が減ると、白背景では光が強すぎて目が痛くなる。夜はディスプレイをみない生活をするのが最も健康によいのだが、そうもいかないことがある。夜でも目に負担をかけずに使用するには黒背景にするなどして光を弱めたほうがよい。

　つまりlight/dark切替は、環境光の強さに応じて変更すべきである。しかし環境光を計測する機器などふつう備わっていない。そこで妥協案を採用する。つまり日没時間を計算し、その時刻になったら自動的にdarkモードに切り替えるのだ。

　日没すれば環境光は弱まる。ただ、天候が悪かったり、暗所で作業しているなど、他の要因によって環境光が弱い場合もある。それについては先述のとおり捕捉できない。したがって人間の手でも随時変更できるようにすべきである。

　基本的には人の手でボタンを押して切り替える。その手間をできるだけ減らす工夫として、日没時間の計測によるlight/darkモードの自動変更をする。そういう考えだ。これこそが現在、多くの環境で見やすい状況をつくる最善策であろう。

　ではOSのlight/darkモードに合わせる必要はあるのか？　OSによってはlight/darkを管理していないものもある。たとえば2021年1月時点でのRaspberry PI OSがそうだ。OS側で管理していない場合でも、light/darkモードは使いたい。なので手動による切替は必要。その場合は手動による切替しかないため、単純明快である。

　問題はOS側にlight/darkモードがある場合だ。そのとき、本ツールはOS側に連動すべきか？　

変更する方法|概要
------------|----
手動のみで変更する|OSとは別に管理できるし、そうせねばならない
OSのみで変更する|OSと連動するし、そうするしかない
独自アルゴリズムのみ|日没日時をアプリで独自に計算し、リアルタイムに変更する。
手動・OS連動|OSと連動できるが、手動でも変えることができてしまう。自由だが操作ミスによる変更もできてしまう
手動・独自アルゴリズム|独自アルゴリズムにまかせるが、手動でも変えることができてしまう。自由だが操作ミスによる変更もできてしまう
手動・OSS連動・独自アルゴリズム|OSと連動できる。独自アルゴリズムとの優先度を設定せねばならない。手動でも変えることができてしまう。自由だが操作ミスによる変更もできてしまう

　OS側で日没時間や環境光などにより自動的に変更してくれるなら、独自アルゴリズムでそれを実装する必要がない。ただ、そんな環境はまだ少ない。そうまでして実装しても、実装コストや計算負荷が高いなど割に合わない可能性が高い。それならショートカットキーやアイコンによりワンタッチで切り替えられるようにしたほうがよいのではないか？　ミスタッチも考慮せねばならないため、最優先であるページ遷移の邪魔にならぬようにすべきだが。

　現在の実装は「手動・OS連動」である。実装と計算のコストが高い独自アルゴリズムを避けた中で最も選択肢の多いパターンだ。パフォーマンスも考慮せねばならないため、費用対効果の薄い独自実装は避けたほうが賢明だろう。

### ショートカットキー

　どう実装すべきか。

* 1種類のキーで切り替える
* 2種類のキーでそれぞれに設定する

key|spel|概要
---|----|----
`c`|`color-scheme`|現状のカラースキーム(light/dark)を反転する

key|spel|概要
---|----|----
`l`|`light`|lightモードにする
`d`|`dark`|darkモードにする








key|spel|概要
---|----|----
`f`|`full-screen`|全画面／窓　を切り替える

key|spel|概要
---|----|----
`f`|`full-screen`|全画面にする
`w`|`windowed`|窓（非全画面）にする


## 前回終了時の復元

　light/darkモードに関しては、はたして前回終了時の復元をすべきか疑問である。それよりも起動時点での環境光の強さに応じて適切に設定すべきだろう。ただし環境光の計測ができる環境はほぼゼロ。

1. 現在の環境光に応じて自動的に変更する
1. 現在時刻（日没時間と日の出時間）に応じて自動的に変更する
1. OSの設定と連動する
1. 手動で変更する
    * ショートカットアイコンのタッチ（クリック）
    * アイコンなし（画面端などのタッチ（クリック））
    * ショートカットキー押下

　日没時間のリアルタイム判定は負荷が高い。だが初回ロード時に1回やるだけなら負荷も少ない。それを採用してもいいだろう。それをやることで初回処理とし、light/darkの前回終了時復元はやらない。

　ただ、OSと連動するときはどうするか。もしOSが日没時間により計算しているならそれにまかせればよい。だが、もしユーザの好みがたまたまダークモードだったり、今はダークモードにしたい気分だったりしたとき、そちらに合わせたいこともあるだろう。さすがにユーザの気分をキャッチすることはできないため、ユーザによる操作で変更してもらうほかない。では、独自アルゴリズムによる日没時間判定とOS設定、どちらを優先すべきか？　日没時間を優先すべきだろう。

　日没時間を優先すべき。その理由は先述のとおり環境光への対応だ。これに関しては座標情報がいる。デフォルトでは東京としておけばいいだろう。ついでに札幌、沖縄など主要都市をいくつか選択肢にすればいい。あとは自由に入力できるようにする。Googleマップと連携することになるだろう。またはIPアドレスからAPの座標を入手するとか。

* https://developer.mozilla.org/ja/docs/Web/API/Geolocation_API

　セキュリティを考えるならGoogleマップからGPS座標情報の文字列を取得し、LocalStorageやIndexedDBに保存すればよい。その座標情報をもとに日没時間を算出する。

　ただ、ここまでやってもできることがlight/darkの自動変更である。はたして割に合うのか。やはりIPアドレスから自動的に座標を取得したい。あるいはデフォルト値を東京にしてそこから時差を入力したい。とにかく入力を楽にしたい。

　つまり以下の処理をほどこしたい。

* ショートカットキーによるlight/dark切替を実装する
* 初回ロード時に「東京」の座標から日没時間・日の出時間を算出し、現在時刻から判定してlight/darkモードを指定する

　自動化の精度を高めたいときはGeolocation APIによりGPSを使って位置情報を取得するか、Googleマップによる位置情報の設定をする。

