# 0.68 余白調整

## 機能と実装の対応表

是非|機能
----|----
⭕|フォントサイズ計算（40〜50字／行）
⭕|字間設定
⭕|行間設定
⭕|段組（inline方向が1600px(50字*16px*2段=1600)以上のとき）
⭕|余白表示
⭕|ページ単位表示（見切れない）
⭕|ページ送り
⭕|全画面
⭕|writing-mode切替（縦／横）
⭕|明暗切替
⭕|補足情報の表示（ヘッダ（ノンブル,残りページ数,読了率）、フッタ（柱（章名）,現在時刻,経過時間））
⭕|補足情報の表示（）
⭕|補足情報の表示（）
⭕|補足情報の表示（）
⭕|補足情報の表示（）
⭕|補足情報の表示（）

## 優先実装すべき機能の考察

是非|バグ
----|----
|フォント計算バグ（字／行スライダー調整時まれに1字ズレる）

是非|機能
----|----
|前回終了時の復元（IndexedDB）
|余白設定
|補足情報の表示切替（ヘッダ（ノンブル,残りページ数,読了率）、フッタ（柱（章名）,現在時刻,経過時間）。タイマー実装してからのほうがよい。タイマー設定時の表示方法を考察してからでないと表示設定項目を確定できない）
|Index機能（俯瞰・遷移（表紙、目次、扉、章））
|速読モード（要約。パラグラフの先頭文（要約文）のみ抽出する）
|挿絵（段組み。`column-span:all`）
|表（writing-mode, 段組みのときどのように表示されるか調査するところから）
|`<pre><code>`（縦書きのときでもソースコードは横書きで表示すべきか考察するところから）
|ダイアログ表示最適化（表示位置。配色。）
|タイマー＆通知（スヌーズ）
|通知（視覚（トースト表示）。音声（効果音。ボイス）。バイブレーション）
|色設定（chroma.js）
|ランダム色設定（明暗ボタン押下時その設定を引き継ぎつつ色付けする）
|読み上げ（OpenJTalk）＆自動ページめくり
|ショートカットキー最適化
|操作方法ヘルプ（キーボード、マウス、タッチ、ゲームパッド）[WebHID API][]

[WebHID API]:https://developer.mozilla.org/en-US/docs/Web/API/WebHID_API

是非|機能
----|----
|UI最適化（WebComponent化。[element-plus][]。[dark-mode-toggle][]）
|最適UI考察（Slider/Spinner, RadioButton/Combobox）
|ES Module化
|パフォーマンス最適化（Node.js(Deno)によるWebPackやMinify。WASM。）
|

是非|機能
----|----
|中間書式パーサ（ブログ（Markdown）、小説（青空文庫、なろう、カクヨム）、独自形式）
|ジェネレータ（中間書式からHTMLファイルを作成する）
|プレビューア（中間書式をパースしてHTMLに変換して表示する）
|文字数カウンタ（読了時間カウンタ）
|エディタ（現在字数カウンタ）
|相互変換（Markdown,青空文庫、なろう、カクヨム、アルファポリス、ePub、PDF、HTML、プレーンテキスト、...）

[element-plus]:https://element-plus.org/en-US/component/layout.html
[dark-mode-toggle]:https://github.com/GoogleChromeLabs/dark-mode-toggle


　直近では「余白設定」を実装しようと思っていた。これは補足情報表示設定への布石にもなる。ただ、補足情報のうちタイマーなど表示や通知が必要な項目がまだ他にあるかもしれない。たとえばブックマークしたらそのページの画面端に`🔖`アイコンを表示するなど。そうしたすべての補足情報を洗い出してからでないと、その表示設定ON/OFFの項目を確定できない。あとから追加してもよいが、どうせなら一挙にやったほうがいいと思う。

　最優先は「前回終了時の復元（IndexedDB）」だろう。とくに現在ページの復元は最優勢である。ページ数は画面サイズやフォントサイズに依存しているため、それらの復元も必要。ただ、ブラウザの拡大縮小率に関してはJSで操作できないため、狂ってしまう可能性がある。私は13インチディスプレイを使用しているのだが文字が小さいため、ブラウザの設定で新しいページは必ず150%で表示するようにしている。そのため翌日、続きから読もうと起動したときは拡大率150%ではじまってしまう。この拡大率をJSで調整できればよかったのだが、できないっぽい。

```markdown
# データ構造を表す

## 部分(構造。階層。領域（区分）)

### 構造（順序、位置、階層なし）

* 順序／位置
* 階層

　構造は順序または位置のいずれかがあるか、どちらも

順序／位置|階層
----------|----
順|⭕
位|⭕
☓|⭕
順|☓
位|☓
☓|☓

#### 構造（順序、位置、階層なし）

　全体を構成する要素（部品）を列挙する。要素は同じ階層であるほうがわかりやすい。だが、まだまとまっていない場合、階層分けもされていない状態である。その状態でもメモしたいときはあるため許可する。

```
* 部品1
* 部品2
* 部品3
```

#### 構造（あり（順序）、なし（位置、階層））

　順序あり。「トップダウン」か「ボトムアップ」の２方向。以下はシステム構成図を「トップダウン」方向に表示している。

```
UserSetting
-------
App
-------
VM
-------
SDK
-------
Driver
-------
Kernel
-------
OS
```

　以下はシステム構成図を「ボトムアップ」方向で表示している。

```
OS
-------
Kernel
-------
Driver
-------
SDK
-------
VM
-------
App
-------
UserSetting

```

　基本的に中間書式（Markdown亜種）で書くときは以下のようにする。


```
- UserSetting
- App
- VM
- SDK
- Driver
- Kernel
- OS
```

　だが、これだけだと順序方向がどちらか明示できていない。また、何についての構造なのかもわからない。そこで次のようにしようと思う。

```
- システム構成図
    - UserSetting
    - App
    - VM
    - SDK
    - Driver
    - Kernel
    - OS
```
```
+ システム構成図
    + OS
    + Kernel
    + Driver
    + SDK
    + VM
    + App
    + UserSetting
```

　他にもまだ問題がある。

　表示方向をどうするか。

* １次元
    * 横
        * 左右
        * 右左
    * 縦
        * 上下
        * 下上
* ２次元
    * 縦横
        * 英語圏
            * 左右上下
        * 日本語圏
            * 上下右左
        * 他
            * 左右下上
            * 右左上下
            * 下上右左
            * 下上左右

記号|名前|inline方向|block方向|折り返し方向
----|----|----------|---------|------------
`Z`|横書き|左右|上下|斜め（右上→左下）
`N`|縦書き|上下|右左|斜め（右下→左上）
`己`|横書き|左右|上下|下（右上→右下、左上→左下）
`凵`,`⊔`,`⊔`,`̺`|縦書き|上下|右左|左（右下→左下、右上→左上）
`卍`|混在|混在|混在|ランダム

* https://q.hatena.ne.jp/1109245726

　縦でなく横に表示したいかもしれない。そして折り返す方法は斜めではなく下や左かもしれない。

```
UserSetting|App|VM|SDK|Driver|Kernel|OS
```

　折り返し（斜め）
```
UserSetting|App|VM|
SDK|Driver|Kernel|OS
```
　折り返し（下）
```
UserSetting|App|VM|
OS|Kernel|Driver|SDK
```
　順序ありなので「トップダウン」から「ボトムアップ」に変更すると以下。

```
OS|Kernel|Driver|SDK|VM|App|UserSetting
```

　折り返し（斜め）

```
OS|Kernel|Driver|SDK|
VM|App|UserSetting
```

　折り返し（下）

```
OS|Kernel|Driver|SDK|
UserSetting|App|VM
```

　縦書きで折り返し（斜め）

```
OS  SDK     UserSetting
    Driver  App
    Kernel  VM
```

　縦書きで折り返し（左）

```
OS  Kernel  UserSetting
    Driver  App
    SDK     VM
```

#### 構造（あり（順序、階層）、なし（位置））

　全体を構成する要素（部品）をすべて網羅し、階層付けしたもの。ピラミッドで表現され、抽象・具象を階層構造で表している。全体を要約して概要をサクっと把握する「抽象モード」と、詳細をすべて網羅する「具象モード」がある。ようするにディレクトリの展開と収納である。

```
UserSetting
-------
App
-------
VM
-------
SDK
-------
Driver
  +---------------+---------------------+
  |HID            |記憶装置             |
  |+-------+-----+|+---+---------------+|
  ||Keybord|Mouse|||HDD|USB FlashMemory||
  |+-------+-----+|+---+---------------+|
  +---------------+---------------------+
-------
Kernel
-------
OS
```
```
- UserSetting
- App
- VM
- SDK
- Driver
    - HID
        - Keybord
        - Mouse
    - 記憶装置
        - HDD
        - USB FlashMemory
- Kernel
- OS
```

* リストのタイトル（何のリストか）
* 順序ありか（`*`:なし、`-`/`+`:あり）
* 順序方向はどちらか（`-`:ボトムアップ,`+`:トップダウン）
* 階層はあるか（インデントの有無で判断）
* 表示方向の指定

　方向はCSS（スタイル）で定義するのが現状である。だが本当にそれでいいのだろうか？　表示方向は文書構造の一部ではないだろうか。表示方向はデータ構造の属性である。言語圏において初期値が定まり、一定のルールに従う。方向は順序になり、順序はアルゴリズムの重要な要素である。もし順序が違ってしまえば意味をなさなくなったり、真逆の意味になってしまう。文書を意味づけするなら、文書の順序付けせねばならないはずだ。つまり、文書要素の順序付けは文書構造である。よって順序付けはCSSでなくHTMLで定義すべき項目だと私は考える。

　要素の順序方向は「トップダウン」と「ボトムアップ」の２種類と考えて良い。文章は文字列であり、文字列は文字が一次元（一方向）に伸びてゆく。段落についても上から下へと進んでゆくため一次元である。よってリストも同じく一次元でよい。ただし記載するときはトップダウンかボトムアップのどちらか一方だけにしたい。その上で表示は両方できるようにしつつ、デフォルト値は記載した方向のものを使用したい。

　表示方向はwriting-modeと一致させると単純化、法則化できて直感的になるだろう。すなわち横書きならリストも横に表示する。縦書きならリストも縦に表示する。深い階層をみるときに逆方向へ展開する。

横書き（トップダウン）
```
UserSetting|App|VM|SDK|Driver|Kernel|OS
```

横書き（ボトムアップ）
```
OS|Kernel|Driver|SDK|VM|App|UserSetting
```

横書き（トップダウン）
```
UserSetting|App|VM|SDK|Driver|Kernel|OS
----------------------+      +---------
HID|記憶装置
```

横書き（トップダウン２階層目）
```
Driver
HID|記憶装置
```

横書き（ボトムアップ２階層目）
```
Driver
記憶装置|HID
```

横書き（トップダウン３階層目）
```
HID < Driver
Keybord|Mouse
```

横書き（ボトムアップ２階層目）
```
Driver > HID
Mouse|Keybord
```

　パンくずリストは`<`方向のほうが見やすい。理由は横書きのときは左から先にみることと、抽象から具象へと遷移してきた経緯があるからだ。１行目の親階層の左端は直上の親であるし、二行目の左端は末弟である。すなわち最新要素が左端から順に表示されるわけだ。ふつう、閲覧するときには最新情報がほしい。よって時系列順としては降順がデフォルトであってほしい。なので`<`方向に表示したほうが直感的でありわかりやすいのだろう。

　選択していない項目を省いたほうが本文に集中できる。だが選択項目をすべて表示したほうが全体像を把握しやすい。詳細より概要の把握が重要なときは以下のように全項目が一度に閲覧できるように表示したほうがよい。

横書き（トップダウン３階層まで）
```
UserSetting|App|VM|SDK|Driver|Kernel|OS
----------------------+      +---------
+---------------+---------------------+
|HID            |記憶装置             |
|+-------+-----+|+---+---------------+|
||Keybord|Mouse|||HDD|USB FlashMemory||
|+-------+-----+|+---+---------------+|
+---------------+---------------------+
```

　もっとも、これもピラミッド階層を平坦化しているため誤解を与えるかもしれない。正しくは包含関係にあるため、以下のようにするのがよい場合もあるだろう。

```

UserSetting----------
  App
    VM
      SDK
        Driver----------------+
        |HID-----+-----+      |
        ||Keybord|Mouse|      |
        |+-------+-----+      |
        |記憶装置------------+|
        ||HDD|USB Flashmemory||
        |+---+---------------+|
        +---------------------+
          Kernel--------------+
          |                   |
          +-------------------+
            OS----------------+
            |                 |
            +-----------------+

```

```
UserSetting|App|VM|SDK|Driver|Kernel|OS         TopDown/
```


　ただし表示方向についてはCSSで対応すべきである。


### 構造（あり（位置、階層）、なし（順序））

### 階層

```
     +------------+
     |頭          |
     |    +--+    |
     |    |髪|    |
     |    +--+    |
     |+--++--++--+|
     ||耳||額||耳||
     |+--++--++--+|
     |+--++--++--+|
     ||目||鼻||目||
     |+--++--++--+|
     |+--++--++--+|
     ||頬||口||頬||
     |+--++--++--+|
     |    +--+    |
     |    |首|    |
     |    +--+    |
+----+------------+----+
|腕  |胴          |腕  |
|+--+|  +--++--+  |+--+|
||肩||  |胸||  |  ||肩||
|+--+|  +--+|背|  |+--+|
|+--+|  +--+|  |  |+--+|
||肘||  |腹||  |  ||肘||
|+--+|  +--++--+  |+--+|
|+--++------------++--+
||手||腰          ||手||
|+--+|  +--++--+  |+--+|
|+--+|  |股||尻|  |+--+|
||指||  +--++--+  ||指||
|+--++------------++--+|
+----+脚          +----+
     |    +--+    |
     |    |腿|    |
     |    +--+    |
     |    +--+    |
     |    |膝|    |
     |    +--+    |
     |    +--+    |
     |    |脛|    |
     |    +--+    |
     |    +--+    |
     |    |足|    |
     |    +--+    |
     +------------+
```
```
裏

+--+
|背|  胸、腹
+--+
+--+
|尻|　股
+--+
```


### ベン図

```
Ａ
　　＿　　＿　
　／　＼／　＼
｜Ｂ　／＼Ｃ ｜
｜　 ｜Ｄ｜　｜
｜　　＼／　 ｜
　＼＿／＼＿／
```

```
Ｚ：全体
Ａ：要素A
Ｂ：要素B
Ｃ：要素C
Ｄ：AB
Ｅ：AC
Ｆ：BC
Ｇ：ABC
　　　＿
　　／　＼
　｜Ａ　　｜

　＿　　＿　　＿
／　＼／　＼／　＼
Ｂ　　　Ｃ
```

### 領域（区分）

```
|--[A]--|--[B]--|--[C]--|
```

四象限
```
          抽象
           |           
      [A]  |  [B]         
           |           
過去-------+--------未来
           |           
      [C]  |  [D]       
           |           
          具象
```


## 順序

* 手順
* 優先度

### 手順

　リストを上から順にすべて行うことでひとつの目標が達成できる。

1. 手順1
2. 手順2
3. 手順3

### 優先度

　優先順位を表す。順位、項目名、理由の３項目が必要。さらに理由については詳細化することで別の優先順位パターンを作成することもできるようにしたい。リストというよりは表（テーブル。グリッド）になる。

1. 項目名１（理由）
1. 項目名２（理由）
1. 項目名３（理由）
```

## 分岐

　リストのうちいずれかひとつを選択する。

A. 分岐A
B. 分岐B
C. 分岐C



## 余白調整の考察

　余白の調整方法について考える。精度と労力のトレードオフがある。細かく調整できるようにすると満足度は高いだろうが、調整や実装に手間がかかる。大雑把に調整できるようにすると細部にこだわれないものの、手間なく実装・調整できる。

* 最小限
* 最大限
* 中間

### 最小限

　用途に応じで大雑把に調整できるようにする。

モード|概要
------|----
余白なし|余白がなく全画面に本文を表示する。ノンブルさえもない。スマホなど小さい画面のとき用。
ノンブルのみ|画面下端にノンブルを表示する。そのための余白がある。それ以外の余白はない。余白は`1em`。
ノンブル＋|四辺`1em`の余白あり。
フル|2.5emの余白がある。ページヘッダとページフッタの要素をすべて表示する。

### 最大限

```
☑ 余白
----------------------------------------
       [1]em
[1]em         [1]em
       [1]em

☑ 表示
----------------------------------------
☑ 現在時刻      ☑ 経過時間  ☑ 柱
                ☑ つめかけ
☑ 残りページ数  ☑ ノンブル  ☑ 読了率
```

### 中間

```
余白 [1]em

☑ 現在時刻      ☑ 経過時間  ☑ 柱
☑ 残りページ数  ☑ ノンブル  ☑ 読了率

```

　余白は四辺ともすべて同じとする。`0.5`em刻み。`0`〜`4`まで。`1`以下であれば補足情報はすべて非表示となる。表示すべき領域が足りず、本文と重なってしまうから。

　余白については四辺とも同じにしてしまって良いだろう。本は上の余白が多めのことが多いが、それほど気にするようなことではない。それより補足情報の非表示が重要。とくにページヘッダは邪魔になることが多い。本文に集中したいときは非表示にできるようにする。

　簡単かつ手早く今の自分にとって見やすくする。そのためには設定をショートカットキーで指定できることが好ましい。

## キーボード・ショートカット

key|役割
---|----
`n`|次ページへ
`p`|前ページへ
`f`|最初のページへ
`l`|最後のページへ
`m`|指定ページ入力ダイアログ表示

　次・前はもっとも重要な操作のため他の主なキーにも割り当てる。

key|役割
---|----
`←`,`→`|次・前
`PgUp`,`PgDn`|次・前
`SPACE`,`Shift+SPACE`|次・前
`Enter`,`Shift+Enter`|次・前
`BkSp`|前

　以下も英単語から次・前を連想しやすい。だが`f`はフルスクリーン、`b`はブックマークに使いたい。逆に`n`は`next`,`new`など次を連想させるし、ブログでも`next`,`prev`がよく使われる。`p`は`page`の頭文字でもある。よってページ遷移には`n`,`p`を使用し、`f`,`b`は他の用途にする。

key|役割
---|----
`f`|`forward` 進む
`b`|`back` 戻る

　大メニューを表示する。

key|役割
---|----
`i`|index表示
`s`|setting表示

key|setting
---|-------
`w`|縦書き／横書き
`v`,`N`|縦書き
`h`,`Z`|横書き
`f`,`F11`|全画面／通常画面
`c`|明／暗
`l`|明
`d`|暗
`C`|段組み増減

key|setting
---|-------
`H`|ページヘッダ表示／非表示
`M`|余白サイズ入力ダイアログ表示

key|役割
---|----
`u`|UnDo。直前の操作を取り消す
`b`|ブックマークする（移動するまで上書きできない）
`B`|ブックマークへ移動する（移動したらクリアされて移動できなくなると同時に上書きできるようになる）
`c`|中間テキストの全本文コピー(markdown, 青空文庫書式など)
`C`|HTMLパースした全本文コピー
`N`|次の章へ
`P`|前の章へ
`s`|この章の要約（summary）。全要約文
``|
``|
``|
``|
``|
``|

　実用書の場合、速読モード（要約モード）がほしい。つまり要約だけを読んですばやく概要を把握するスタイル。

1. 目次
1. 各章の扉（各章の目次）
1. 指定した章の全要約文（箇条書き）
1. 指定した要約文の全文

　あまり多くのキーがあるとミスタッチによる誤操作が問題になる。押したつもりがないのに押してしまい、何がどうなったか把握できなかったり、もとに戻せなくなったり、戻すのに手間がかかったり。本末転倒になっていまいかねない。創作文か実用文かによって読み方も変わるため、ショートカットキーやメニュー項目を適切に変更したほうがよいだろう。

* どれだけの機能をもりこむか
* どれだけのショートカットキーをもりこむか

