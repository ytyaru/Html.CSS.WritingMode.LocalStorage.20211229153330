<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title></title>
<meta name="description" content="">
<meta name="author" content="ytyaru">
<link rel="license" href="https://creativecommons.org/licenses/by-sa/3.0/deed.ja">
<!--<link rel="icon" href="assets/image/avator.png">-->
<link rel="icon" href="https://ytyaru.github.io/Html.CSS.WritingMode.LocalStorage.20211229153330/assets/images/avator.png">
<link rel="stylesheet" href="css/styles.css">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=0">
<script src="js/inherits.js"></script>
<script src="js/debug.js"></script>
<script src="js/define-class.js"></script>
<script src="js/assets.js"></script>
<script src="js/html.js"></script>
<script src="js/css.js"></script>
<script src="js/define-const.js"></script>
<script src="js/page-header.js"></script>
<script src="js/page-footer.js"></script>
<script src="js/full-screen.js"></script>
<script src="js/color-scheme.js"></script>
<script src="js/column-count.js"></script>
<script src="js/writing-mode.js"></script>
<script src="js/resize.js"></script>
<script src="js/line-of-chars.js"></script>
<script src="js/line-height.js"></script>
<script src="js/letter-spacing.js"></script>
<script src="js/margin.js"></script>
<script src="js/setting-sub-info.js"></script>
<script src="js/screen-area.js"></script>
<script src="js/paging.js"></script>
<script src="js/clock.js"></script>

<script src="./js/lib/common/file-loader.js"></script>
<script src="./js/lib/common/style.js"></script>
<script src="./js/lib/common/element-string.js"></script>
<script src="./js/lib/common/regexp-chars.js"></script>
<script src="./js/lib/parser/parse-set.js"></script>
<script src="./js/lib/parser/heading-parse-set.js"></script>
<script src="./js/lib/parser/paragraph-parse-set.js"></script>
<script src="./js/lib/parser/ruby-parse-set.js"></script>
<script src="./js/lib/parser/em-parse-set.js"></script>
<script src="./js/lib/parser/span-upright-parse-set.js"></script>
<script src="./js/lib/parser/parse-set-factory.js"></script>
<script src="./js/lib/parser/parser.js"></script>

<script src="js/tsv-table.js"></script>
<script src="js/book-shelf.js"></script>
<!--<script src="js/main.js"></script>-->
<script>
window.addEventListener('DOMContentLoaded', async(event) => {
    Debug.on();
    defineConst('Html', defineHtml());
    defineConst('Css', defineCss());
    defineConst('Screen', defineScreen());

    initFullScreen();
    initWritingMode();
    initColorScheme();
    initColumns();
    initLineOfChars();
    initLineHeight();
    initLetterSpacing();
    initMargin();
    initSettingSubInfo();
    setPageHeaderPosition();
    setPosPageFooter();
    initClock();

    // https://domain.co.jp/books/0/0
    // https://domain.co.jp/book-page?book=0&file=0
    // https://domain.co.jp/book-page?book=0&file=0&page=-1
    console.debug(location.href)
    const url = new URL(location.href);
    console.debug(url)
    for (const key of ['book', 'file']) {
        if (!url.searchParams.has(key)) { throw 'URLå¼•æ•°ã‚¨ãƒ©ãƒ¼ã€‚bookã¨fileãŒå¿…è¦ã§ã™ã€‚'; }
    }
    const bookUrl = `./book/${url.searchParams.get('book')}/${url.searchParams.get('file')}.txt`
    const parser = new Parser();
    defineConst('NovelParser', parser);
    const book = await FileLoader.text(bookUrl);
    const content = parser.parse(`${book}`);
    Html.Main.innerHTML = `${content}\n${Html.Main.innerHTML}`;

    // ãªãœã‹ã‚¯ãƒªãƒƒã‚¯ã›ãšã‚­ãƒ¼å…¥åŠ›ã‚’æœ€åˆã«ã™ã‚‹ã¨ãƒšãƒ¼ã‚¸ãŒçœŸã£ç™½ã«ãªã‚‹ï¼ content-visibilityãŒautoã ã¨ãã†ãªã‚‹ãŒã€visibleã ã¨OKã€‚
    document.querySelector(':root').style.setProperty('--content-visibility', 'visible'); 

    // UIã¨ã‚¤ãƒ™ãƒ³ãƒˆã‚’ã™ã¹ã¦ä½œæˆã—çµ‚ãˆãŸã‚‰æœ€å¾Œã«ä¸€åº¦ã ã‘é‡ã„å‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹ï¼ˆãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã¨ãƒšãƒ¼ã‚¸ã®è¨ˆç®—ï¼‰
    setFontSizePixel();
    Paging.break();

    console.log(url.searchParams.has('page'))
    if (url.searchParams.has('page')) {
        const page = parseInt(url.searchParams.get('page'));
        console.log(page)
        Paging.Page = page;
        console.log(Paging.Page)
    }

    // ãƒ•ã‚¡ã‚¤ãƒ«é–“é·ç§»ã™ã‚‹ã¨ãæœ€å¤§ãƒ•ã‚¡ã‚¤ãƒ«æ•°ãŒå¿…è¦ãªã®ã§ä¿æŒã—ã¦ãŠãã€‚
    defineConst('IndexDatas', TsvTable.toObjects(await FileLoader.text('./book/index.tsv')));

    window.addEventListener('load', (event) => {
        console.debug("load");
    });
    window.addEventListener('beforeunload', (event) => {
        console.debug("beforeunload");
        saveFullScreen();
        saveColumns();
        saveWritingMode();
        saveLineOfChars();
        saveLineHeight();
        saveSettingSubInfo();
        saveMargin();
        saveLetterSpacing();
        removeClock();
    });
    window.addEventListener("orientationchange", function () { // ç”»é¢å‘ãã«å¿œã˜ã¦æœ€å¤§å­—æ•°ï¼è¡Œã‚’å¤‰æ›´ã™ã‚‹
        console.debug("orientationchange");
        setMaxColumns(); // columns.js
        setMaxLineOfChars(); // resize.js
        setFontSizePixel(); // resize.js
        Paging.break();
    });
    window.addEventListener("resize", function (e) { // å…¨ç”»é¢ã‚„ãƒªã‚µã‚¤ã‚ºæ™‚ã«å­—ï¼è¡Œã®å€¤ã‚’å†è¨ˆç®—ã™ã‚‹
        console.debug("resize");
        setMaxColumns(); // columns.js
        setMaxLineOfChars(); // resize.js
        setFontSizePixel(); // resize.js
        Paging.break();
    });
    // OSã®ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰å¤‰æ›´ã«åˆã‚ã›ã‚‹
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
        console.debug('=============================');
        setColorScheme((event.matches) ? 'dark' : 'light')
    });
    window.addEventListener('touchstart', (event) => { // ã‚¿ãƒƒãƒ
        console.debug('touchstart', event);
        const setting = document.querySelector('#setting');
        if (setting.open) { if(!event.target.closest('#setting > form[method="dialog"]')) {setting.close();} return; }
        Screen.on(event.touches[0].X, event.touches[0].Y);
    });
    window.addEventListener('click', (event) => { // ãƒã‚¦ã‚¹ï¼ˆã‚¯ãƒªãƒƒã‚¯ï¼‰
        const setting = document.querySelector('#setting');
        if (setting.open) { if(!event.target.closest('#setting > form[method="dialog"]')) {setting.close();} return; }
        Screen.on(event.clientX, event.clientY);
    });
    window.addEventListener('mousemove', (event) => { // ãƒã‚¦ã‚¹ï¼ˆç§»å‹•ï¼‰
        if (document.querySelector('#setting').open) { return; }
        // bodyå†…ã«è¦ç´ ãŒãªã„é ˜åŸŸã¯åå¿œã—ãªã„ï¼ã€€æœ«å°¾ãƒšãƒ¼ã‚¸ã¯ä¸‹ç«¯ã¾ã§ãªã„ç®‡æ‰€ã§ã¯åå¿œã—ãªã„ï¼
        document.body.style.cursor = Screen.cursor(event.clientX, event.clientY);
    });
    window.addEventListener("keydown", event => { // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰
        if (event.repeat) { return; } // æŠ¼ã—ã£ã±ãªã—ã«ã‚ˆã‚‹é€£ç¶šå…¥åŠ›ã®ç¦æ­¢
        if (document.querySelector('#setting').open) { return; }
        const IS_VERTICAL = ('vertical-rl' === document.querySelector('#writing-mode').value);
        console.debug(`keydown event.key:${event.key}, Shift:${event.shiftKey}`)
             if (event.key === 'ArrowUp') { event.preventDefault();  }   // menu(index,setting,tools)è¡¨ç¤ºäºˆå®š
        else if (event.key === 'ArrowDown') { // settingè¡¨ç¤ºåˆ‡æ›¿
            const dialog = document.querySelector('#setting');
            (dialog.open) ? dialog.close() : dialog.showModal();
            document.body.style.cursor = 'auto';
            event.preventDefault();
        }
        else if (event.key === 'ArrowLeft') {(IS_VERTICAL) ? Paging.Page++ : Paging.Page--; event.preventDefault();  }
        else if (event.key === 'ArrowRight') {(IS_VERTICAL) ? Paging.Page-- : Paging.Page++; event.preventDefault();  }
        else if (event.key === 'PageUp') {Paging.Page--;event.preventDefault();}
        else if (event.key === 'PageDown') {Paging.Page++;event.preventDefault();}
        else if (event.key === 'Home') {firstPage();event.preventDefault();}
        else if (event.key === 'End') {lastPage();event.preventDefault();}
        else if (!event.shiftKey && event.key === ' ') {Paging.Page++;event.preventDefault();}
        else if (event.shiftKey && event.key === ' ') {Paging.Page--;event.preventDefault();}
        else if (!event.shiftKey && event.key === 'Enter') {Paging.Page++;event.preventDefault();}
        else if (event.shiftKey && event.key === 'Enter') {Paging.Page--;event.preventDefault();}
        else if (event.key === 'Backspace') {Paging.Page--;event.preventDefault();}
        else if (event.key === 'Escape') {;event.preventDefault();} // æœ¬ã‚’é–‰ã˜ã‚‹äºˆå®šï¼ˆæœ¬æ£šã«æˆ»ã‚‹ï¼‰
        else {}
    }, {passive: false});
    window.addEventListener("keypress", event => { // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰
        console.debug(`keypress event.key:${event.key}`)
        if (document.querySelector('#setting').open) { if (event.key === 'Escape') {document.querySelector('#setting').close(); event.preventDefault();} return; }
        const IS_VERTICAL = ('vertical-rl' === document.querySelector('#writing-mode').value);
        if (event.key === 'n') {Paging.Page++;}
        else if (event.key === 'p') {Paging.Page--;}
        else if (event.key === 'f') {Paging.Page=1;}
        else if (event.key === 'l') {Paging.Page=-1;}

        // 'u' undo å‰ã®ç§»å‹•ã‚’å–ã‚Šæ¶ˆã™
        // 'm' move ç§»å‹•ã™ã‚‹ãƒšãƒ¼ã‚¸ã‚’çµ¶å¯¾å€¤ã§æŒ‡å®šã™ã‚‹
        else if (event.key === 'm') {
            const page = window.prompt('ä½•ãƒšãƒ¼ã‚¸ç›®ã«ç§»å‹•ã—ã¾ã™ã‹ï¼Ÿ', `${Paging.Page}`);
            Paging.Page = parseInt(page);
        }
        // 'h' here ç¾åœ¨ã“ã“ã¯ä½•ãƒšãƒ¼ã‚¸ç›®ã‹ã‚’è¡¨ç¤ºã™ã‚‹
        // 't' time ç¾åœ¨æ™‚åˆ»ã€‚çµŒéæ™‚åˆ»ã€‚æŒ‡å®šæ™‚é–“ã€æŒ‡å®šæ™‚åˆ»ã¾ã§ã®æ®‹ã‚Šæ™‚é–“ã‚’è¡¨ç¤ºã™ã‚‹
        // 'i' index ä½œå“å,ç›®æ¬¡,ç·¨,ç« ,ãƒšãƒ¼ã‚¸æ•°,è‘—è€…å(è‘—è€…ä»–ä½œå“ãƒªãƒ³ã‚¯ã¸)
        // 's' setting
        else if (event.key === 's') {
            const dialog = document.querySelector('#setting');
            (dialog.open) ? dialog.close() : dialog.showModal();
            document.body.style.cursor = 'auto';
        }
        else if (event.key === 'S') { // ä½™ç™½ï¼ˆè£œè¶³æƒ…å ±ï¼‰ã®è¡¨ç¤ºï¼éè¡¨ç¤ºåˆ‡æ›¿
            const SUB = document.querySelector('#sub-info-disabled');
            SUB.checked = !SUB.checked;
            SUB.dispatchEvent(new Event('change'));
        }
        else if (event.key === 'c') {
            const COLOR_SCHEME = document.getElementById('color-scheme');
            setColorScheme(COLOR_SCHEME.value);
        }
        else if (event.key === 'F') {
            setFullScreen(!(document.fullscreenElement));
        }
        else if (event.key === 'w') {
            document.getElementById('writing-mode').dispatchEvent(new Event('click'));
        }
        else {}
    }, {passive: false});

});

</script>
</head>
<body>
    <header>
    <dialog id="setting">
    <form id="setting-form" method="dialog">
        <button type="button" id="full-screen" name="full-screen" value="0" title="ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ON/OFF"><img src="https://ytyaru.github.io/Html.CSS.WritingMode.LocalStorage.20211229153330/assets/images/icons/full-screen.svg"></img></button>
        <button type="button" id="writing-mode" name="writing-mode" value="vertical-rl" title="ç¸¦æ›¸ãï¼æ¨ªæ›¸ã"><img src=""></img></button>
        <button type="button" id="color-scheme" name="color-scheme" value="light" title="light/dark">ğŸŒ™</button>
        <input type="range" id="column-count" name="column-count" min="1" max="3"><label for="column-count"><span id="column-count-label" class="upright"></span><span class="upright">æ®µ</span></label>
        <br>
        <input type="range" id="line-of-chars" name="line-of-chars" min="10" max="50"><label for="line-of-chars"><span id="line-of-chars-label" class="upright"></span><span class="upright">å­—ï¼è¡Œ</span></label>
        <input type="range" id="line-height" name="line-height" min="1.5" max="2.0" step="0.05"><label for="line-height"><span id="line-height-label" class="upright"></span><span class="upright">ï¼…å­—</span><span class="upright">è¡Œé–“</span></label>
        <input type="range" id="letter-spacing" name="letter-spacing" min="0.05" max="0.1" step="0.005"><label for="letter-spacing"><span id="letter-spacing-label" class="upright"></span><span class="upright">ï¼…å­—</span><span class="upright">å­—é–“</span></label>
        <fieldset id="sub-info-fieldset" name="sub-info-fieldset">
            <legend><label><input type="checkbox" id="sub-info-disabled" name="sub-info-disabled">è£œè¶³æƒ…å ±</label></legend>
            <input type="range" id="margin" name="margin" min="1.5" max="4" step="0.5"><label for="margin"><span id="margin-label" class="upright"></span><span class="upright">å­—</span><span class="upright">ä½™ç™½</span></label>
            <div id="page-header-visibility">
            <label id="clock-visibility-label"><input type="checkbox" id="clock-visibility">ç¾åœ¨æ™‚åˆ»</label>
            <label id="elapsed-time-visibility-label"><input type="checkbox" id="elapsed-time-visibility">çµŒéæ™‚é–“</label>
            <label id="now-section-heading-visibility-label"><input type="checkbox" id="now-section-heading-visibility">æŸ±</label>
            </div>
            <!--<input type="checkbox" id="is-"><label for="is-">ã¤ã‚ã‹ã‘</label>-->
            <div id="page-footer-visibility">
            <label id="read-rate-visibility-label"><input type="checkbox" id="read-rate-visibility">èª­äº†ç‡</label>
            <label id="page-number-visibility-label"><input type="checkbox" id="page-number-visibility">ãƒšãƒ¼ã‚¸</label>
            <label id="remaining-pages-visibility-label"><input type="checkbox" id="remaining-pages-visibility">æ®‹ã‚Šãƒšãƒ¼ã‚¸æ•°</label>
            </div>
            <div id="sub-info-visibility">
            </div>
        </fieldset>
    </form>
    </dialog>
    </header>
 
    <div id="page-header"><div id="clock">ç¾åœ¨æ™‚åˆ»</div><div id="elapsed-time">çµŒéæ™‚é–“</div><div id="now-section-heading" heading="ç¾åœ¨é–²è¦§ä¸­ã®è¦‹å‡ºã—"></div></div>
    <div id="page-footer"><div id="remaining-pages"></div><div id="page-number"></div><div id="read-rate"></div></div>

    <main>
    </main>

</body>
</html>
<!-- https://coliss.com/articles/build-websites/operation/work/html-template-for-web-apps-or-sites.html -->
<!-- https://coliss.com/articles/build-websites/operation/work/html5-template-for-2018.html -->
